<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ordnungsdienst & Termine</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; max-width:760px}
    h1{margin:0 0 14px}
    h2{margin:18px 0 10px; font-size:1.1rem}
    .card{border:1px solid #ddd; border-radius:14px; padding:14px 16px; margin:10px 0}
    .muted{color:#555}
    ol, ul{margin:10px 0 0 22px}
    li{margin:6px 0; font-size:1.05rem}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-block; padding:2px 10px; border:1px solid #ddd; border-radius:999px; font-size:0.9rem; color:#444}
    .err{color:#b00020}
    .table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 10px;
}
.table th, .table td {
  text-align: left;
  padding: 10px 10px;
  vertical-align: top;
  border-top: 1px solid #eee;
}
.table th {
  font-size: 0.9rem;
  color: #555;
  font-weight: 600;
}
.table td.date {
  white-space: nowrap;
  width: 110px;
  font-variant-numeric: tabular-nums;
}
.table td.info {
  color: #555;
}
.badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 0.85rem;
  border: 1px solid #ddd;
}
.badge-ok { background: #f1fff4; border-color: #bfe8c9; }
.badge-warn { background: #fff6f6; border-color: #f2b8b8; }
.badge-neutral { background: #f6f7f9; border-color: #e2e4e9; }

.countdown {
  margin-top: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid #f2b8b8;
  background: #fff6f6;
}
.countdown strong { font-weight: 700; }
.small { font-size: 0.9rem; color: #555; }
.announce {
  border-color: #ffd66b;
  background: #fff9e6;
}
.announce h2 {
  margin: 0 0 8px;
  font-size: 1.05rem;
}
.announce ul { margin: 8px 0 0 20px; }
.service-card { border-color:#e6e6e6; }
.service-head { display:flex; justify-content:space-between; align-items:baseline; gap:12px; flex-wrap:wrap; }
.service-title { font-size:1.05rem; font-weight:700; margin:0; }
.service-sub { color:#555; font-size:0.95rem; margin-top:4px; }
.service-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px 14px; margin-top:12px; }
.service-name {
  border:1px solid #eee;
  border-radius:12px;
  padding:10px 12px;
  font-size:1.05rem;
}
.service-foot { margin-top:12px; color:#555; font-size:0.9rem; }
.kv { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
.kv .badge { font-size:0.85rem; }

  </style>
</head>
<body>
  <h1>üìã Klasseninfos 8A</h1>
<div class="card" id="announceCard" style="display:none"></div>

  <div class="card" id="dienstCard">Lade‚Ä¶</div>

  <div class="row">
    <span class="pill" id="statusPill">‚Äî</span>
  </div>

  <div class="card" id="termineCard">
    <h2>üìå Termine</h2>
    <div id="termineOut" class="muted">Lade‚Ä¶</div>
  </div>

  <div class="card" id="kaCard">
    <h2>üìù Klassenarbeiten</h2>
    <div id="kaOut" class="muted">Lade‚Ä¶</div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxLIoQW3X4m-DHnHPFluK0uA79493EoSzO6ZNpACBaJkEE_2i0lrP4Za0aocjiegYf2gw/exec";

// ISO "YYYY-MM-DD" -> Date
function parseISODate(iso) {
  return new Date(iso + "T00:00:00");
}

// "YYYY-MM-DD" -> "Mo 23.2.26"
function formatShortDate(isoDate) {
  const d = parseISODate(isoDate);
  const wd = d.toLocaleDateString("de-DE", { weekday: "short" }).replace(".", "");
  const rest = d.toLocaleDateString("de-DE", { day: "numeric", month: "numeric", year: "2-digit" });
  return `${wd} ${rest}`;
}

// ISO oder Date-String -> "Montag 9.2.26"
function formatLongDate(value) {
  const s = String(value);
  const m = s.match(/(\d{4})-(\d{2})-(\d{2})/);
  const d = m ? new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`) : new Date(value);
  if (isNaN(d.getTime())) return s;

  const weekday = d.toLocaleDateString("de-DE", { weekday: "long" });
  const rest = d.toLocaleDateString("de-DE", { day: "numeric", month: "numeric", year: "2-digit" });
  return `${weekday} ${rest}`;
}

function daysUntil(iso) {
  const today = new Date();
  const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const d = parseISODate(iso);
  const diff = d.getTime() - t0.getTime();
  return Math.round(diff / (1000 * 60 * 60 * 24));
}

function renderTable(containerId, items, headers, rowHtml, emptyText) {
  const el = document.getElementById(containerId);
  if (!items || items.length === 0) {
    el.innerHTML = `<div class="muted">${emptyText}</div>`;
    return;
  }
  el.innerHTML = `
    <table class="table">
      <thead>
        <tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${items.map(rowHtml).join("")}
      </tbody>
    </table>
  `;
}

function setStatusPill(pill, state) {
  // state: "ok" | "neutral" | "warn"
  pill.className = "pill badge " + (state === "ok" ? "badge-ok" : state === "warn" ? "badge-warn" : "badge-neutral");
}

async function main() {
  const dienstCard = document.getElementById("dienstCard");
  const statusPill = document.getElementById("statusPill");

  const url = API_URL + (API_URL.includes("?") ? "&" : "?") + "t=" + Date.now();

  const r = await fetch(url, { cache: "no-store", redirect: "follow" });
  const text = await r.text();

  let d;
  try {
    d = JSON.parse(text);
    

  } catch {
    const start = formatLongDate(d.monday);
const end = d.friday ? formatLongDate(d.friday) : "";
const range = end ? `${start} ‚Äì ${end}` : start;

dienstCard.className = "card service-card";
dienstCard.innerHTML = `
  <div class="service-head">
    <div>
      <div class="service-title">üßπ Ordnungsdienst</div>
      <div class="service-sub">${range}</div>
    </div>
    <span class="badge badge-neutral">${d.kw}</span>
  </div>

  <div class="service-grid">
    ${d.ordnungsdienst.map(n => `<div class="service-name"><b>${n}</b></div>`).join("")}
  </div>

  <div class="service-foot">Diese Einteilung gilt f√ºr die ganze Woche.</div>
`;

    statusPill.textContent = "Fehler";
    setStatusPill(statusPill, "warn");
    return;
  }
const announceCard = document.getElementById("announceCard");
const anns = d.ankuendigungen || [];

if (anns.length > 0) {
  announceCard.style.display = "block";
  announceCard.className = "card announce";
  announceCard.innerHTML =
    `<h2>üì£ Wichtige Ank√ºndigungen</h2>` +
    `<ul>${anns.map(a => `<li><b>${a.text}</b></li>`).join("")}</ul>`;
} else {
  announceCard.style.display = "none";
}

  if (d.error) {
    dienstCard.innerHTML = `<div class="err">Fehler im Script:</div><div class="muted">${d.error}</div>`;
    statusPill.textContent = "Fehler";
    setStatusPill(statusPill, "warn");
  } else if (!d.ordnungsdienst || d.ordnungsdienst.length === 0) {
    dienstCard.innerHTML = `<b>${d.kw ?? ""}</b><div class="muted" style="margin-top:6px">Kein Ordnungsdienst (Ferien / keine Schulwoche).</div>`;
    statusPill.textContent = "Ferien/leer";
    setStatusPill(statusPill, "neutral");
  } else {
    const start = formatLongDate(d.monday);
    dienstCard.innerHTML =
      `<div><b>${d.kw}</b></div>
       <div>ab <b>${start}</b></div>
       <ol>${d.ordnungsdienst.map(n => `<li><b>${n}</b></li>`).join("")}</ol>
       <div class="muted" style="margin-top:10px">Diese Einteilung gilt f√ºr die ganze Woche.</div>`;
    statusPill.textContent = "Aktuell";
    setStatusPill(statusPill, "ok");
  }

  // Termine (Tabelle)
  renderTable(
    "termineOut",
    d.termine,
    ["Datum", "Termin", "Info"],
    (it) => `
      <tr>
        <td class="date"><b>${formatShortDate(it.date)}</b></td>
        <td>${it.a || ""}</td>
        <td class="info">${it.b ? it.b : ""}</td>
      </tr>
    `,
    "Keine Termine eingetragen."
  );

  // Klassenarbeiten (Tabelle + Countdown)
  renderTable(
    "kaOut",
    d.klassenarbeiten,
    ["Datum", "Fach", "Thema"],
    (it) => {
      const left = daysUntil(it.date);
      const cd = left === 0 ? "Heute" : (left === 1 ? "Morgen" : `in ${left} Tagen`);
      return `
        <tr>
          <td class="date"><b>${formatShortDate(it.date)}</b></td>
          <td>${it.a || ""}</td>
          <td class="info">
            ${it.b ? it.b : ""}
            <div class="small">‚è≥ ${cd}</div>
          </td>
        </tr>
      `;
    },
    "Keine Klassenarbeiten eingetragen."
  );
}

main().catch(err => {
  document.getElementById("dienstCard").innerHTML = `<div class="err">Fehler beim Laden:</div><div class="muted">${err.message}</div>`;
  const pill = document.getElementById("statusPill");
  pill.textContent = "Fehler";
  pill.className = "pill badge badge-warn";
});
</script>

</body>
</html>







