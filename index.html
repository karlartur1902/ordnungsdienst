<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ordnungsdienst & Termine</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; max-width:760px}
    h1{margin:0 0 14px}
    h2{margin:18px 0 10px; font-size:1.1rem}
    .card{border:1px solid #ddd; border-radius:14px; padding:14px 16px; margin:10px 0}
    .muted{color:#555}
    ol, ul{margin:10px 0 0 22px}
    li{margin:6px 0; font-size:1.05rem}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-block; padding:2px 10px; border:1px solid #ddd; border-radius:999px; font-size:0.9rem; color:#444}
    .err{color:#b00020}
    .table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 10px;
}
.table th, .table td {
  text-align: left;
  padding: 10px 10px;
  vertical-align: top;
  border-top: 1px solid #eee;
}
.table th {
  font-size: 0.9rem;
  color: #555;
  font-weight: 600;
}
.table td.date {
  white-space: nowrap;
  width: 110px;
  font-variant-numeric: tabular-nums;
}
.table td.info {
  color: #555;
}
.badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 0.85rem;
  border: 1px solid #ddd;
}
.badge-ok { background: #f1fff4; border-color: #bfe8c9; }
.badge-warn { background: #fff6f6; border-color: #f2b8b8; }
.badge-neutral { background: #f6f7f9; border-color: #e2e4e9; }

.countdown {
  margin-top: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid #f2b8b8;
  background: #fff6f6;
}
.countdown strong { font-weight: 700; }
.small { font-size: 0.9rem; color: #555; }

  </style>
</head>
<body>
  <h1>üìã Ordnungsdienst</h1>

  <div class="card" id="dienstCard">Lade‚Ä¶</div>

  <div class="row">
    <span class="pill" id="statusPill">‚Äî</span>
  </div>

  <div class="card" id="termineCard">
    <h2>üìå Termine</h2>
    <div id="termineOut" class="muted">Lade‚Ä¶</div>
  </div>

  <div class="card" id="kaCard">
    <h2>üìù Klassenarbeiten</h2>
    <div id="kaOut" class="muted">Lade‚Ä¶</div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwWVzsQsEIX-iImcrQK7XU8XqC1WCB2503ZWslhrpnVcGD5Ip2B4jUN03LDH7M5qa6qRw/exec";

// "2026-02-09" -> "Mo 9.2.26"
function formatShortDate(isoDate) {
  const d = new Date(isoDate + "T00:00:00");
  const wd = d.toLocaleDateString("de-DE", { weekday: "short" }); // "Mo."
  const rest = d.toLocaleDateString("de-DE", { day: "numeric", month: "numeric", year: "2-digit" });
  return `${wd.replace(".", "")} ${rest}`; // "Mo 9.2.26"
}

// ISO oder Date-String -> "Montag 9.2.26"
function formatLongDate(value) {
  // robust: wenn ISO vorhanden, nutze es
  const s = String(value);
  const m = s.match(/(\d{4})-(\d{2})-(\d{2})/);
  const d = m ? new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`) : new Date(value);
  if (isNaN(d.getTime())) return s;

  const weekday = d.toLocaleDateString("de-DE", { weekday: "long" });
  const rest = d.toLocaleDateString("de-DE", { day: "numeric", month: "numeric", year: "2-digit" });
  return `${weekday} ${rest}`; // ohne Komma
}
function parseISODate(iso) {
  // iso: "YYYY-MM-DD"
  return new Date(iso + "T00:00:00");
}

function daysUntil(iso) {
  const today = new Date();
  const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const d = parseISODate(iso);
  const diff = d.getTime() - t0.getTime();
  return Math.round(diff / (1000 * 60 * 60 * 24));
}

function formatShortDate(isoDate) {
  const d = parseISODate(isoDate);
  const wd = d.toLocaleDateString("de-DE", { weekday: "short" }).replace(".", "");
  const rest = d.toLocaleDateString("de-DE", { day: "numeric", month: "numeric", year: "2-digit" });
  return `${wd} ${rest}`;
}

function renderTable(containerId, items, headers, rowHtml, emptyText) {
  const el = document.getElementById(containerId);
  if (!items || items.length === 0) {
    el.innerHTML = `<div class="muted">${emptyText}</div>`;
    return;
  }
  el.innerHTML = `
    <table class="table">
      <thead>
        <tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${items.map(rowHtml).join("")}
      </tbody>
    </table>
  `;
}

function renderList(containerId, items, emptyText, mapper) {
  const el = document.getElementById(containerId);
  if (!items || items.length === 0) {
    el.innerHTML = `<div class="muted">${emptyText}</div>`;
    return;
  }
  el.innerHTML = `<ul>${items.map(mapper).join("")}</ul>`;
}

async function main() {
  const dienstCard = document.getElementById("dienstCard");
  const statusPill = document.getElementById("statusPill");

  // Cache-Buster
  const url = API_URL + (API_URL.includes("?") ? "&" : "?") + "t=" + Date.now();

  const r = await fetch(url, { cache: "no-store", redirect: "follow" });
  const text = await r.text();

  let d;
  try {
    d = JSON.parse(text);
  } catch {
    dienstCard.innerHTML = `<div class="err">Fehler: Server hat kein JSON geliefert.</div>
      <div class="muted" style="margin-top:8px">Anfang der Antwort:</div>
      <pre style="white-space:pre-wrap">${text.slice(0, 400).replaceAll("<","&lt;")}</pre>`;
    statusPill.textContent = "Fehler";
    return;
  }

  if (d.error) {
    dienstCard.innerHTML = `<div class="err">Fehler im Script:</div><div class="muted">${d.error}</div>`;
    statusPill.textContent = "Fehler";
  } else if (!d.ordnungsdienst || d.ordnungsdienst.length === 0) {
    dienstCard.innerHTML = `<b>${d.kw ?? ""}</b><div class="muted" style="margin-top:6px">Kein Ordnungsdienst (Ferien / keine Schulwoche).</div>`;
    statusPill.textContent = "Ferien/leer";
  } else {
    const start = formatLongDate(d.monday); // "Montag 9.2.26"
    dienstCard.innerHTML =
      `<div><b>${d.kw}</b></div>
       <div>ab <b>${start}</b></div>
       <ol>${d.ordnungsdienst.map(n => `<li><b>${n}</b></li>`).join("")}</ol>
       <div class="muted" style="margin-top:10px">Diese Einteilung gilt f√ºr die ganze Woche.</div>`;
    statusPill.textContent = "Aktuell";
  }

 // Termine-Tabelle
renderTable(
  "termineOut",
  d.termine,
  ["Datum", "Termin", "Info"],
  (it) => `
    <tr>
      <td class="date"><b>${formatShortDate(it.date)}</b></td>
      <td>${it.a || ""}</td>
      <td class="info">${it.b ? it.b : ""}</td>
    </tr>
  `,
  "Keine Termine eingetragen."
);

// Klassenarbeiten-Tabelle + Countdown
renderTable(
  "kaOut",
  d.klassenarbeiten,
  ["Datum", "Fach", "Thema"],
  (it) => {
    const left = daysUntil(it.date);
    const cd = left === 0 ? "Heute" : (left === 1 ? "Morgen" : `in ${left} Tagen`);
    return `
      <tr>
        <td class="date"><b>${formatShortDate(it.date)}</b></td>
        <td>${it.a || ""}</td>
        <td class="info">
          ${it.b ? it.b : ""}
          <div class="small">‚è≥ ${cd}</div>
        </td>
      </tr>
    `;
  },
  "Keine Klassenarbeiten eingetragen."
);

}

main().catch(err => {
  document.getElementById("dienstCard").innerHTML = `<div class="err">Fehler beim Laden:</div><div class="muted">${err.message}</div>`;
  document.getElementById("statusPill").textContent = "Fehler";
});
</script>

</body>
</html>



